<!DOCTYPE html>
<html lang="en">
<head>
<!-- Apr 23, 2021 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AWS Notes</title>
<meta name="generator" content="Org mode">
<meta name="author" content="DESKTOP-TTOPQ58">
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='https://code.cdn.mozilla.net/fonts/fira.css'>
<link rel='stylesheet' href='/css/site.css?v=2' type='text/css'/>
<link rel='stylesheet' href='/css/custom.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax-coloring.css' type='text/css'/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../"> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><header id="top" class="status">
<div class="intro">
  <img
    src="/images/Lisplogo_alien_256.png"
    alt="Land of Lisp"
    class="no-border"
  />
  <h1>
    <span class="gray">Zhao</span>
    <span class="black">Wei</span>
  </h1>
  <p>
    How can man die better than facing fearful odds, for the ashes of his
    fathers and the temples of his Gods? -- By Horatius.
  </p>
</div>

<div class="nav">
  <ul>
    <li><a href="/">Posts</a>.</li>
    <li><a href="/about/">About</a>.</li>
  </ul>
</div>
</header>
<main id="content">
<header>
<h1 class="title">AWS Notes</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4cb8ec1">ECS</a>
<ul>
<li><a href="#orgdd5e038">Refs</a></li>
<li><a href="#org85e5388">Concepts</a>
<ul>
<li><a href="#org2bb94dd">ECS</a></li>
<li><a href="#orgd82cd27">EC2</a></li>
<li><a href="#org51f17b2">Farget and EC2</a></li>
<li><a href="#org3444717">Task Definitions</a></li>
<li><a href="#org3e64e03">Cluster</a></li>
</ul>
</li>
<li><a href="#org6dfaf42">Features of ECS</a></li>
<li><a href="#org48ba91f">Steps to use ECS</a></li>
<li><a href="#orge7545b1"><span class="todo TODO">TODO</span> About AutoScaling of EC2</a>
<ul>
<li><a href="#orgea24e32">Similar example from App-worker-manager</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc505e12">Route53</a>
<ul>
<li><a href="#org0f5ffd6">Switch traffic to different domain name as failover</a></li>
<li><a href="#org03480a6">LoadBalancer in ECS</a></li>
</ul>
</li>
<li><a href="#org56fe89f">AWS Security</a>
<ul>
<li><a href="#orgb3cb63c">refs</a></li>
<li><a href="#org93e74d1">My notes</a>
<ul>
<li><a href="#org4643b0f">Office building analogy</a></li>
<li><a href="#orgf698697">VPC</a></li>
<li><a href="#org94282f3">Subnets</a></li>
<li><a href="#orgd7b3b4d">Security Group</a></li>
<li><a href="#orgeca8ec2">Launch instance into VPC</a></li>
<li><a href="#orgbb05454">Bastion host</a></li>
</ul>
</li>
<li><a href="#org15d373b">My summary</a></li>
</ul>
</li>
<li><a href="#org9670a86">ECR</a></li>
<li><a href="#orgc8377ff">Troubleshootings</a></li>
<li><a href="#org39ad89c"><span class="todo TODO">TODO</span> VPC</a>
<ul>
<li><a href="#org8e6d707">Refs</a></li>
<li><a href="#orgcc312d7">VPC networking components</a></li>
</ul>
</li>
<li><a href="#org3717110">CloudFormation Skills</a>
<ul>
<li><a href="#org40843f9">Use FindInMap to customize environment variables based on keys</a></li>
</ul>
</li>
<li><a href="#org1ccd092">My notes</a>
<ul>
<li><a href="#org41d381e">Network Fundamentals</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<section id="outline-container-org4cb8ec1" class="outline-2">
<h2 id="org4cb8ec1">ECS</h2>
<div class="outline-text-2" id="text-org4cb8ec1">
</div>
<div id="outline-container-orgdd5e038" class="outline-3">
<h3 id="orgdd5e038">Refs</h3>
<div class="outline-text-3" id="text-orgdd5e038">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/42960678/what-is-the-difference-between-a-task-and-a-service-in-aws-ecs">What is the difference between a task and a service in AWS ECS?</a></li>
<li><a href="https://medium.com/boltops/gentle-introduction-to-how-aws-ecs-works-with-example-tutorial-cea3d27ce63d">Gentle Introduction to How AWS ECS Works with Example Tutorial</a></li>
</ul>
</div>
</div>
<div id="outline-container-org85e5388" class="outline-3">
<h3 id="org85e5388">Concepts</h3>
<div class="outline-text-3" id="text-org85e5388">
</div>
<div id="outline-container-org2bb94dd" class="outline-4">
<h4 id="org2bb94dd">ECS</h4>
<div class="outline-text-4" id="text-org2bb94dd">
<ul class="org-ul">
<li>abbreviation  for <b>Elastic Container Service</b>. It is a container <b>management</b> service for containers on a cluster.</li>
<li><b>Task Definition</b> defines one or multiple containers to construct as a application.</li>
<li>A <b>Task</b> is an instance of task definition.</li>
<li>A <b>Service</b> is used to guarantee that you always have some number of Tasks running at all times. Such as, make sure there are always 3 running task across different zones.</li>
<li>A <b>Cluster</b> is used to manage a collection of resources such as CPU, memory, etc.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd82cd27" class="outline-4">
<h4 id="orgd82cd27">EC2</h4>
<div class="outline-text-4" id="text-orgd82cd27">
<ul class="org-ul">
<li>Short for <b>Elastic Compute Cloud (Amazon EC2)</b></li>
</ul>
</div>
</div>
<div id="outline-container-org51f17b2" class="outline-4">
<h4 id="org51f17b2">Farget and EC2</h4>
<div class="outline-text-4" id="text-org51f17b2">
<ul class="org-ul">
<li>Both are cluster service types.</li>
<li>Farget doesn&rsquo;t need server. It still need docker image.</li>
<li>EC2 need server and allow you to have more control on it.</li>
</ul>
</div>
</div>
<div id="outline-container-org3444717" class="outline-4">
<h4 id="org3444717"><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html">Task Definitions</a></h4>
<div class="outline-text-4" id="text-org3444717">
<ul class="org-ul">
<li>describes one or more <b>containers</b>, up to 10</li>
<li>blueprint for your application:
<ul class="org-ul">
<li>which containers/image to use</li>
<li>which launch type ?</li>
<li>which port</li>
<li>what data volumes should be used with the containers</li>
</ul></li>
<li><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/example_task_definitions.html">Different task examples</a></li>
<li>A <b>task is the instantiation of a task definition within a cluster</b>.</li>
<li>A <b>Service runs and maintains a specified number of tasks</b>.</li>
</ul>
</div>
</div>

<div id="outline-container-org3e64e03" class="outline-4">
<h4 id="org3e64e03">Cluster</h4>
<div class="outline-text-4" id="text-org3e64e03">
<ul class="org-ul">
<li>A logical grouping of resources.</li>
<li>For Fargate type, AWS ECS manages cluster resources automatically.</li>
<li>For EC2, you need to manage a group of container instances.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6dfaf42" class="outline-3">
<h3 id="org6dfaf42">Features of ECS</h3>
<div class="outline-text-3" id="text-org6dfaf42">
<ul class="org-ul">
<li>provide high available manner for
<ul class="org-ul">
<li>across multiple zones</li>
<li>within one Region</li>
</ul></li>
<li>schedule the placement of containers across your cluster based on:
<ul class="org-ul">
<li>your resource needs</li>
<li>isolation policies</li>
<li>availability requirements</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org48ba91f" class="outline-3">
<h3 id="org48ba91f">Steps to use ECS</h3>
<div class="outline-text-3" id="text-org48ba91f">
<ul class="org-ul">
<li>Define VPC</li>
<li>Create clusters within a new or existing VPC.</li>
<li>Create tasks (from task definition) to run in Service in Cluster.
<ul class="org-ul">
<li>Running task is instance of task definition.</li>
</ul></li>
<li>For ECS, you need to group task definition with service description.
<ul class="org-ul">
<li>Running task is instance of Service which is {task definition, Service description}</li>
</ul></li>
<li>Docker image is created for tasks, and it is prepared in AWS ECR or Docker-Hub</li>
</ul>
</div>
</div>

<div id="outline-container-orge7545b1" class="outline-3">
<h3 id="orge7545b1"><span class="todo TODO">TODO</span> About AutoScaling of EC2</h3>
<div class="outline-text-3" id="text-orge7545b1">
<ul class="org-ul">
<li>ref: <a href="https://aws.amazon.com/blogs/containers/deep-dive-on-amazon-ecs-cluster-auto-scaling/">Deep Dive on Amazon ECS Cluster Auto Scaling</a></li>
</ul>
</div>

<div id="outline-container-orgea24e32" class="outline-4">
<h4 id="orgea24e32">Similar example from App-worker-manager</h4>
<div class="outline-text-4" id="text-orgea24e32">
<p>
Worker manager relies on two tables.
</p>
<ul class="org-ul">
<li><p>
<code>app-dummy-service-task-definitions-drdev</code>, its schema:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Pooling</td>
<td class="org-left">ScaleTo</td>
<td class="org-left">TaskArn</td>
<td class="org-left">TaskDef</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>It manages pool. Pool lists all the workers available to use.</li>
<li>It acts as a <b>plan table</b> (like how much memory I should need). It records:
<ul class="org-ul">
<li>For a specific version, how many I should keep it in hot pool.</li>
<li>For a speicif version, it is used/defined in which ECS task definition.</li>
</ul></li>
<li>The value for TaskArn and TaskDef is generated from <b>worker-pipeline</b>:
<ul class="org-ul">
<li>After pushing worker into ECR, a new ECS task definition for worker is generated for new available worker. Worker manager will use this worker-task-definition to star worker.</li>
</ul></li>
</ul></li>
<li><p>
<code>app-worker-manager-hotpool-drdev</code>, its schema:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">UUID</td>
<td class="org-left">DT</td>
<td class="org-left">Available</td>
<td class="org-left">Ip</td>
<td class="org-left">Port</td>
<td class="org-left">ServiceApiId</td>
<td class="org-left">TaskArn</td>
<td class="org-left">TaskDefArn</td>
<td class="org-left">WorkerVersion</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>It acts as a <b>implementation/progress table</b> for the <code>app-dummy-service-task-definitions-drdev</code>, plan table.
<ul class="org-ul">
<li>How to allocate those memory(worker), or which worker version is used in which ECS task instance.</li>
<li>For example, if the plan table set <code>ScaleTo=6</code> and <code>Pooling=Y</code> for <code>TaskDef=NX119</code>. Then, this implementation table will add 6 records. They show where those 6 workers have been used in which ECS task instances.</li>
</ul></li>
<li>After &ldquo;the memory has been allocated&rdquo;, if there are clients coming in and used those worker (consume some/all those memory). Then, in the next checking point (every 15mins), worker manager will need to allocate new workers as planed.</li>
</ul></li>
<li>A related table, <code>app-dummy-service-data-drdev</code>.
<ul class="org-ul">
<li>This table records all the client activities which also includes which worker has been used for what purpose.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-orgc505e12" class="outline-2">
<h2 id="orgc505e12">Route53</h2>
<div class="outline-text-2" id="text-orgc505e12">
<ul class="org-ul">
<li>To make Route53 works, you need to create 2 records: one is type A, another is CNAME which is created during validate certificate.</li>
</ul>
</div>
<div id="outline-container-org0f5ffd6" class="outline-3">
<h3 id="org0f5ffd6">Switch traffic to different domain name as failover</h3>
<div class="outline-text-3" id="text-org0f5ffd6">
<ul class="org-ul">
<li>Task description
<ul class="org-ul">
<li>Given two domains: <code>lb.dev.app.com</code> as primary service and <code>lb.drdev.app.com</code> secondary service, we want to create another hosted zone in Route53 <code>acs.app.com</code>.</li>
<li>In normal case, we let <code>dev.acs.app.com</code> to route traffice to <code>lb.dev.app.com</code>.</li>
<li>In disaster case, we let <code>dev.acs.app.com</code> to route traffice to <code>lb.drdev.app.com</code>.</li>
</ul></li>
<li>Steps
<ul class="org-ul">
<li>Create new hosted zone <code>acs.app.com</code> in Route53.
<ul class="org-ul">
<li><b>If public hosted zone is a third level domain, then add the NS records of this zone to the parent hosted zone</b>.</li>
</ul></li>
<li>Within <code>acs.app.com</code>, create record
<ul class="org-ul">
<li>Routing policy -&gt; Simple routing, next</li>
<li>Define simple record:
<ul class="org-ul">
<li>Record name: <code>dev.acs.app.com</code></li>
<li>Record type: <code>CNAME -- Routes traffice to another domain name and to some AWS resources</code></li>
<li>Value/Route traffice to:
<ul class="org-ul">
<li><code>IP address or another value depending on the record type</code></li>
<li><code>lb.dev.app.com</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li>Troubleshooting01: Could not resolve host: dev.acs.app.com
<ul class="org-ul">
<li><p>
After created CNAME <code>dev.acs.app.com</code> to <code>lb.dev.app.com</code>, we should be able to visit resources under <code>dev.acs.app.com</code> as we visit <code>lb.dev.app.com</code>.
</p>
<div class="org-src-container">
<pre class="src src-sh">curl https://lb.dev.app.com/app/health
{<span class="org-string">"status"</span>:<span class="org-string">"ok"</span>,<span class="org-string">"ts"</span>:1598240637924,<span class="org-string">"local"</span>:<span class="org-string">"8/24/2020, 3:43:57 AM"</span>,<span class="org-string">"utc"</span>:<span class="org-string">"Mon, 24 Aug 2020 03:43:57 GMT"</span>}

curl https://dev.acs.app.com/app/health
curl: (6) Could not resolve host: dev.acs.app.com
</pre>
</div>
<ul class="org-ul">
<li>I forget to add the NS records of hosted zone <code>acs.app.com</code> to its parent hosted zone <code>app.com</code>. After doing so, the DNS resolution shows the following result.</li>
</ul></li>
<li>Domain name resolve in Ubuntu
<ul class="org-ul">
<li><p>
Resolve <code>lb.dev.app.com</code> (endpoint for app-dev)
</p>
<div class="org-src-container">
<pre class="src src-sh">dig lb.dev.app.com

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.13-Ubuntu &lt;&lt;&gt;&gt; lb.dev.app.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 14519
<span class="org-sh-heredoc">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span>

<span class="org-sh-heredoc">;; OPT PSEUDOSECTION:</span>
<span class="org-sh-heredoc">; EDNS: version: 0, flags:; udp: 65494</span>
<span class="org-sh-heredoc">;; QUESTION SECTION:</span>
<span class="org-sh-heredoc">;lb.dev.app.com.            IN      A</span>

<span class="org-sh-heredoc">;; ANSWER SECTION:</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       34.195.245.88</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       34.197.127.0</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       52.7.50.34</span>

<span class="org-sh-heredoc">;; Query time: 80 msec</span>
<span class="org-sh-heredoc">;; SERVER: 127.0.0.53#53(127.0.0.53)</span>
<span class="org-sh-heredoc">;; WHEN: Mon Aug 24 13:27:16 CST 2020</span>
<span class="org-sh-heredoc">;; MSG SIZE  rcvd: 95</span>
</pre>
</div></li>
<li><p>
Resolve <code>dev.acs.app.com</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">dig dev.acs.app.com

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.13-Ubuntu &lt;&lt;&gt;&gt; dev.acs.app.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39460
<span class="org-sh-heredoc">;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1</span>

<span class="org-sh-heredoc">;; OPT PSEUDOSECTION:</span>
<span class="org-sh-heredoc">; EDNS: version: 0, flags:; udp: 65494</span>
<span class="org-sh-heredoc">;; QUESTION SECTION:</span>
<span class="org-sh-heredoc">;dev.acs.app.com.           IN      A</span>

<span class="org-sh-heredoc">;; ANSWER SECTION:</span>
<span class="org-sh-heredoc">dev.acs.app.com.    0       IN      CNAME   lb.dev.app.com.</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       52.7.50.34</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       34.197.127.0</span>
<span class="org-sh-heredoc">lb.dev.app.com.     0       IN      A       34.195.245.88</span>

<span class="org-sh-heredoc">;; Query time: 81 msec</span>
<span class="org-sh-heredoc">;; SERVER: 127.0.0.53#53(127.0.0.53)</span>
<span class="org-sh-heredoc">;; WHEN: Mon Aug 24 13:29:06 CST 2020</span>
<span class="org-sh-heredoc">;; MSG SIZE  rcvd: 117</span>
</pre>
</div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org03480a6" class="outline-3">
<h3 id="org03480a6">LoadBalancer in ECS</h3>
<div class="outline-text-3" id="text-org03480a6">
<div class="org-src-container">
<pre class="src src-yaml"><span class="org-variable-name">AppService</span>:
  <span class="org-variable-name">Type</span>: AWS::ECS::Service
  <span class="org-variable-name">DependsOn</span>:
    - ALBListenerRule
    <span class="org-comment-delimiter">#</span><span class="org-comment">- ServiceRole</span>
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">Cluster</span>: <span class="org-type">!ImportValue</span>
      <span class="org-variable-name">Fn::Sub</span>: ${ECSStackName}-ECSCluster
    <span class="org-variable-name">DesiredCount</span>: <span class="org-type">!FindInMap</span>
      - EnvironmentMap
      - <span class="org-type">!Ref</span> <span class="org-string">'ConfigEnvironment'</span>
      - DesiredCount
    <span class="org-variable-name">LoadBalancers</span>:
      - <span class="org-variable-name">ContainerName</span>: altas-service
<span class="org-yaml-tab">        </span><span class="org-variable-name">ContainerPort</span>: <span class="org-string">'8080'</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">TargetGroupArn</span>: <span class="org-type">!Ref</span> <span class="org-string">'ECSTG'</span>
      - <span class="org-variable-name">ContainerName</span>: altas-service
<span class="org-yaml-tab">        </span><span class="org-variable-name">ContainerPort</span>: <span class="org-string">'8080'</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">TargetGroupArn</span>: <span class="org-type">!Ref</span> <span class="org-string">'ECSTGALB'</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">Role: !Ref 'ServiceRole'</span>
    <span class="org-variable-name">TaskDefinition</span>: <span class="org-type">!Ref</span> <span class="org-string">'TaskDefinition'</span>
    <span class="org-variable-name">PlacementStrategies</span>:
      - <span class="org-variable-name">Field</span>: attribute:ecs.availability-zone
<span class="org-yaml-tab">        </span><span class="org-variable-name">Type</span>: spread
      - <span class="org-variable-name">Field</span>: memory
<span class="org-yaml-tab">        </span><span class="org-variable-name">Type</span>: binpack        
<span class="org-variable-name">ECSTGALB</span>:
  <span class="org-variable-name">Type</span>: AWS::ElasticLoadBalancingV2::TargetGroup
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">HealthCheckIntervalSeconds</span>: 10
    <span class="org-variable-name">HealthCheckPath</span>: /health
    <span class="org-variable-name">HealthCheckProtocol</span>: HTTP
    <span class="org-variable-name">HealthyThresholdCount</span>: 2
    <span class="org-variable-name">Port</span>: 80
    <span class="org-variable-name">Protocol</span>: HTTP
    <span class="org-variable-name">UnhealthyThresholdCount</span>: 2
    <span class="org-variable-name">VpcId</span>: <span class="org-type">!ImportValue</span>
      <span class="org-variable-name">Fn::Sub</span>: ${VPCStackName}-VPCId
    <span class="org-variable-name">TargetGroupAttributes</span>:
      - <span class="org-variable-name">Key</span>: deregistration_delay.timeout_seconds
<span class="org-yaml-tab">        </span><span class="org-variable-name">Value</span>: <span class="org-string">'20'</span>
<span class="org-variable-name">ALBListenerRule</span>:  
  <span class="org-variable-name">Type</span>: AWS::ElasticLoadBalancingV2::ListenerRule
  <span class="org-variable-name">DependsOn</span>:
    - ECSTGALB
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">Actions</span>:
      - <span class="org-variable-name">Type</span>: forward
<span class="org-yaml-tab">        </span><span class="org-variable-name">TargetGroupArn</span>: <span class="org-type">!Ref</span> <span class="org-string">'ECSTGALB'</span>
    <span class="org-variable-name">Conditions</span>:
      - <span class="org-variable-name">Field</span>: path-pattern
<span class="org-yaml-tab">        </span><span class="org-variable-name">Values</span>:
<span class="org-yaml-tab">        </span>  - /app/*
    <span class="org-variable-name">ListenerArn</span>: <span class="org-type">!ImportValue</span>
      <span class="org-variable-name">Fn::Sub</span>: app-alb-${StackEnvironment}-AppPubALBListenerArn
    <span class="org-variable-name">Priority</span>: <span class="org-string">'5'</span>
<span class="org-variable-name">ALBListener</span>:
  <span class="org-variable-name">Type</span>: AWS::ElasticLoadBalancingV2::Listener
  <span class="org-comment-delimiter">#</span><span class="org-comment">DependsOn: ServiceRole</span>
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">DefaultActions</span>:
      - <span class="org-variable-name">Type</span>: forward
<span class="org-yaml-tab">        </span><span class="org-variable-name">TargetGroupArn</span>: <span class="org-type">!Ref</span> <span class="org-string">'ECSTG'</span>
    <span class="org-variable-name">LoadBalancerArn</span>: <span class="org-type">!Ref</span> <span class="org-string">'ECSALB'</span>
    <span class="org-variable-name">Port</span>: <span class="org-string">'80'</span>
    <span class="org-variable-name">Protocol</span>: TCP
<span class="org-variable-name">ECSALB</span>:
  <span class="org-variable-name">Type</span>: AWS::ElasticLoadBalancingV2::LoadBalancer
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">Type</span>: network
    <span class="org-variable-name">Scheme</span>: internal
    <span class="org-variable-name">Name</span>: <span class="org-type">!Sub</span> <span class="org-string">'${VPCStackName}-NLB'</span>
    <span class="org-variable-name">Subnets</span>: <span class="org-type">!If</span>
      - ThirdAZ
      - - <span class="org-type">!ImportValue</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  Fn::Sub</span>: ${VPCStackName}-PrivateSubnet1
<span class="org-yaml-tab">        </span>- <span class="org-type">!ImportValue</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  Fn::Sub</span>: ${VPCStackName}-PrivateSubnet2
<span class="org-yaml-tab">        </span>- <span class="org-type">!ImportValue</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  Fn::Sub</span>: ${VPCStackName}-PrivateSubnet3
      - - <span class="org-type">!ImportValue</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  Fn::Sub</span>: ${VPCStackName}-PrivateSubnet1
<span class="org-yaml-tab">        </span>- <span class="org-type">!ImportValue</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  Fn::Sub</span>: ${VPCStackName}-PrivateSubnet2
    <span class="org-variable-name">LoadBalancerAttributes</span>:
      - <span class="org-variable-name">Key</span>: load_balancing.cross_zone.enabled
<span class="org-yaml-tab">        </span><span class="org-variable-name">Value</span>: <span class="org-string">'true'</span>
<span class="org-variable-name">ECSTG</span>:
  <span class="org-variable-name">Type</span>: AWS::ElasticLoadBalancingV2::TargetGroup
  <span class="org-variable-name">DependsOn</span>: ECSALB
  <span class="org-variable-name">Properties</span>:
    <span class="org-variable-name">HealthCheckIntervalSeconds</span>: 10
    <span class="org-variable-name">HealthCheckPath</span>: /health
    <span class="org-variable-name">HealthCheckProtocol</span>: HTTP
    <span class="org-variable-name">HealthyThresholdCount</span>: 2
    <span class="org-variable-name">Port</span>: 80
    <span class="org-variable-name">Protocol</span>: TCP
    <span class="org-variable-name">UnhealthyThresholdCount</span>: 2
    <span class="org-variable-name">VpcId</span>: <span class="org-type">!ImportValue</span>
      <span class="org-variable-name">Fn::Sub</span>: ${VPCStackName}-VPCId
    <span class="org-variable-name">TargetGroupAttributes</span>:
      - <span class="org-variable-name">Key</span>: deregistration_delay.timeout_seconds
<span class="org-yaml-tab">        </span><span class="org-variable-name">Value</span>: <span class="org-string">'20'</span>                           
</pre>
</div>
</div>
</div>
</section>


<section id="outline-container-org56fe89f" class="outline-2">
<h2 id="org56fe89f">AWS Security</h2>
<div class="outline-text-2" id="text-org56fe89f">
</div>
<div id="outline-container-orgb3cb63c" class="outline-3">
<h3 id="orgb3cb63c">refs</h3>
<div class="outline-text-3" id="text-orgb3cb63c">
<ul class="org-ul">
<li><a href="https://cloudacademy.com/blog/aws-shared-responsibility-model-security/">AWS Shared Responsibility Model: Cloud Security</a></li>
<li><a href="https://cloudacademy.com/blog/aws-security-groups-instance-level-security/">AWS Security Groups: Instance Level Security</a></li>
<li><a href="https://cloudacademy.com/blog/aws-network-acl-vpc-subnets-network-security/">AWS Network ACL and subnets: network level security</a></li>
<li><a href="https://cloudacademy.com/blog/aws-bastion-host-nat-instances-vpc-peering-security/">AWS Security: Bastion Hosts, NAT instances and VPC Peering</a></li>
<li><a href="https://www.rackspace.com/blog/aws-201-understanding-the-default-virtual-private-cloud">Understanding the Default Virtual Private Cloud (VPC)</a></li>
<li><a href="https://www.infoq.com/articles/aws-vpc-explained/">AWS VPC Subnets</a></li>
</ul>
</div>
</div>

<div id="outline-container-org93e74d1" class="outline-3">
<h3 id="org93e74d1">My notes</h3>
<div class="outline-text-3" id="text-org93e74d1">
<ul class="org-ul">
<li>Different models have differences on how security responsibility are devided (where AWS and customer responsibility start and end)
<ul class="org-ul">
<li>model for infrastructure services</li>
<li>model for container services</li>
<li>model for abstrac services</li>
</ul></li>
<li>In <b>infrastructure services</b>, customer needs to look after:
<ul class="org-ul">
<li>client and server side encryption</li>
<li>network traffic protection</li>
<li>security of the operating system</li>
<li>network</li>
<li>firewall configuration</li>
<li>application security</li>
<li>identity and access management</li>
</ul></li>
<li>Container services model has much less requirement for customer</li>
<li>Abstract  services model has least requirement for customer</li>
</ul>
</div>

<div id="outline-container-org4643b0f" class="outline-4">
<h4 id="org4643b0f">Office building analogy</h4>
<div class="outline-text-4" id="text-org4643b0f">
<ul class="org-ul">
<li>Think of your office as a multi-story building</li>
<li>Each floor has multiple suites</li>
<li>Each department like HR, Payroll can sit in one floor (or) multiple floors</li>
<li>Every suite has few rooms</li>
<li><p>
Each room has couple of desk where employees work
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">AWS</th>
<th scope="col" class="org-left">Company</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Region</td>
<td class="org-left">Office building</td>
</tr>

<tr>
<td class="org-left">Availability Zone</td>
<td class="org-left">Each floor</td>
</tr>

<tr>
<td class="org-left">VPC</td>
<td class="org-left">Each department</td>
</tr>

<tr>
<td class="org-left">Subnet</td>
<td class="org-left">Each suite</td>
</tr>

<tr>
<td class="org-left">IP</td>
<td class="org-left">Each desk</td>
</tr>
</tbody>
</table></li>
<li><p>
When company assign desk to employee vs Launch AWS EC2 instance
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Assign desk</th>
<th scope="col" class="org-left">Launch EC2 instance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Which department this employee belongs to</td>
<td class="org-left">We need to pick which VPC this instance should be deployed to</td>
</tr>

<tr>
<td class="org-left">Then identifies which floors the department spans across</td>
<td class="org-left">Then we pick which availability zone (if not, default availability zone)</td>
</tr>

<tr>
<td class="org-left">Then identifies which suites have open desks</td>
<td class="org-left">Then we pick the subnet (if not default subnet)</td>
</tr>

<tr>
<td class="org-left">Assigns one of the open desks to the employee</td>
<td class="org-left">Then an IP from this subnet gets assigned to our EC2 instance (as private IP)</td>
</tr>
</tbody>
</table></li>
<li>Other associated terminologies 
<ul class="org-ul">
<li>Security groups like access card</li>
</ul></li>
</ul>
</div>
</div>


<div id="outline-container-orgf698697" class="outline-4">
<h4 id="orgf698697">VPC</h4>
<div class="outline-text-4" id="text-orgf698697">
<ul class="org-ul">
<li>What is it?
<ul class="org-ul">
<li>Whenever you launch an instance within your AWS account, by default it will be launched into a default VPC and gets public IP and private IP.</li>
<li>A logical virtual network spanning an entire AWS region (one region &#x2013; one default VPC, can create multiple VPCs in a region).</li>
</ul></li>
<li>Six components are created as default parts of VPC
<ul class="org-ul">
<li>VPC CIDR block
<ul class="org-ul">
<li>Every VPC is associated with an IP address range that is part of a <b>Classless Inter-Domain Routing (CIDR)</b> block which will be used to allocated private IP addresses to EC2 instances.</li>
</ul></li>
<li><a href="#org94282f3">Subnets</a>
<ul class="org-ul">
<li>a subnet is associated with only one availability zone (can not span multiple zones)</li>
<li>However, a zone can host multiple subnets.</li>
<li>Each subnet in a VPC is associated with an IPv4 CIDR block that is a a subset of the /16 CIDR block of its VPC.</li>
</ul></li>
<li>Internet gateway
<ul class="org-ul">
<li>Provide connectivity to outside AWS (internet)</li>
<li>A VPC must be attached to an Internet gateway to communicate with internet. Only one IGW can be attached to a VPC at a time.</li>
<li>Bi-direction source and destination network address translation for your EC2 instances.</li>
</ul></li>
<li>Route table
<ul class="org-ul">
<li>Every subnet must be associated with a route table.</li>
<li>If the association is not explicitly defined, then a subnet will be implicitly associated with the main route table.</li>
</ul></li>
<li>Network access control lists (ACLs)</li>
<li><a href="#orgd7b3b4d">Security Group</a></li>
<li>VPC endpoint</li>
</ul></li>
<li>AWS provides security mechanisms for your instances in the form of <b>network ACLs and security groups</b>.</li>
</ul>
</div>
</div>

<div id="outline-container-org94282f3" class="outline-4">
<h4 id="org94282f3">Subnets</h4>
<div class="outline-text-4" id="text-org94282f3">
<ul class="org-ul">
<li>A subnet is a distinct network segment with its own IP address range within the larger VPC CIDR (Classless Inter-Domain Routing) range.</li>
<li>A VPC and have all public or public/private subnet combination.
<ul class="org-ul">
<li>A public subnet is defined by its connection (through a Routing Table) to an <b>Internet Gateway (IGW)</b> within your VPC.</li>
<li>Any subnet without a route to the IGW is considered private.</li>
</ul></li>
<li>A private subnet is a subnet which doesn&rsquo;t have a route to the internet gateway.</li>
<li><b>Steps to create a public subnet</b>
<ol class="org-ol">
<li>VPC &#x2013;&gt; create subnet 
<ul class="org-ul">
<li>select the VPC within which you want to create the subnet</li>
<li>select availability zone</li>
<li>enter CIDR block</li>
</ul></li>
<li>Add an IGW</li>
<li>Attach IGW to a VPC</li>
<li>Add a route to the IGW from your subnet
<ul class="org-ul">
<li>Route Tables &#x2013;&gt; Create Route Table</li>
<li>Select your VPC, select &ldquo;Create&rdquo;</li>
<li>Edit the Route Table just created, give it a route to the outside world
<ul class="org-ul">
<li>Add another route</li>
<li>Enter &rsquo;0.0.0.0/0&rsquo; in Destination (to allow access to any Internet address)</li>
<li>Enter your IGW ID in the &rsquo;Target&rsquo; field.  Save it.</li>
</ul></li>
</ul></li>
<li>Associate your route table with your subnet
<ul class="org-ul">
<li>Select &rsquo;Subnet Associations&rsquo; (while selecting the route table you created, the sections below show different sections)</li>
<li>Select the subnets you wish to associate with this route table using the check box and click &ldquo;save&rdquo;.</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>

<div id="outline-container-orgd7b3b4d" class="outline-4">
<h4 id="orgd7b3b4d">Security Group</h4>
<div class="outline-text-4" id="text-orgd7b3b4d">
<ul class="org-ul">
<li>AWS security groups (SGs) are associated with <b>EC2 instances</b> and provide security at the <b>protocol and port access level</b>.</li>
<li>Working much the same way as a firewall:
<ul class="org-ul">
<li>a set of rules filter traffic coming into and out of an EC2 instance.</li>
</ul></li>
<li>Security groups are specific to a VPC (which VPC the SG will reside).</li>
</ul>
</div>
</div>

<div id="outline-container-orgeca8ec2" class="outline-4">
<h4 id="orgeca8ec2">Launch instance into VPC</h4>
<div class="outline-text-4" id="text-orgeca8ec2">
<ul class="org-ul">
<li>Before launch
<ol class="org-ol">
<li>identify the subnet where this instance need to be launched into.</li>
<li>identify an available zone.</li>
</ol></li>
<li>After launch (Once an instance is created within the VPC/Subnet/Availability Zone)
<ul class="org-ul">
<li>If the you launch the instance into a subnet that has assign public ip address attribute enabled, a public IP address is assigned to the primary network interface (eth0) of the created instance.</li>
<li>A public IP is mapped to the primary private IP through NAT. The public IP will change whenever you stop EC2 instance and start it again.</li>
<li>Notic: that public IP is not the AWS Elastic IP (EIP).</li>
</ul></li>
</ul>
</div>
</div>


<div id="outline-container-orgbb05454" class="outline-4">
<h4 id="orgbb05454">Bastion host</h4>
<div class="outline-text-4" id="text-orgbb05454">
<ul class="org-ul">
<li>Bastion hosts are instances that sit within your public subnet and are typically accessed using SSH or RDP, as jump server.</li>
<li>Purpose: use SSH to log into other instances (within private subnets) deeper within your VPC.</li>
<li>If you require remote connectivity with your private instances over the public internet, then you need it.</li>
<li><b>Basic steps to create a bastion host</b>
<ol class="org-ol">
<li>Launch an EC2 instance as you normally would for any other instance.</li>
<li>Apply OS hardening as required.</li>
<li>Set up the appropriate security groups (SG).</li>
<li>Implement either SSH-agent forwarding (Linux connectivity) or Remote Desktop Gateway (Windows connectivity).</li>
<li>Deploy an AWS bastion host in each of the Availability Zones you&rsquo;re using.</li>
</ol></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org15d373b" class="outline-3">
<h3 id="org15d373b">My summary</h3>
<div class="outline-text-3" id="text-org15d373b">
<ul class="org-ul">
<li>EC2 instance level security is controled by security groups which applies restrictions on instance&rsquo;s protocol and port level.</li>
<li>Network level security is controled by applying network ACLs on subnets (equivalent of the security groups attached to EC2 instances).</li>
</ul>
</div>
</div>
</section>

<section id="outline-container-org9670a86" class="outline-2">
<h2 id="org9670a86">ECR</h2>
<div class="outline-text-2" id="text-org9670a86">
<ul class="org-ul">
<li><p>
pull image from ECR 
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">eval</span> $(<span class="org-sh-quoted-exec">aws</span> ecr get-login --no-include-email --region us-east-1 --profile=default)
</pre>
</div>
<ul class="org-ul">
<li>Need to specify in which region you want to login.</li>
</ul></li>
</ul>
</div>
</section>
<section id="outline-container-orgc8377ff" class="outline-2">
<h2 id="orgc8377ff">Troubleshootings</h2>
<div class="outline-text-2" id="text-orgc8377ff">
<ul class="org-ul">
<li><a href="file:///home/zw/code/capture-org/siemens/work-notes.html#org2d1763f">Cloudfront distribution: the domain name assigned by aws could be visited, but the cname used is not avaiable.</a></li>
<li><a href="file:///home/zw/code/capture-org/siemens/work-notes.html#orga9903bf">Cloudfront distribution: The certificate that is attached to your distribution doesn&rsquo;t cover the alternate domain name (CNAME) that you&rsquo;re trying to add.</a></li>
</ul>
</div>
</section>




<section id="outline-container-org39ad89c" class="outline-2">
<h2 id="org39ad89c"><span class="todo TODO">TODO</span> VPC</h2>
<div class="outline-text-2" id="text-org39ad89c">
</div>
<div id="outline-container-org8e6d707" class="outline-3">
<h3 id="org8e6d707">Refs</h3>
<div class="outline-text-3" id="text-org8e6d707">
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html">Amazon Virtual Private Cloud</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgcc312d7" class="outline-3">
<h3 id="orgcc312d7">VPC networking components</h3>
<div class="outline-text-3" id="text-orgcc312d7">
<ul class="org-ul">
<li>Networking interfaces</li>
<li>Route tables</li>
<li>Prefix lists</li>
<li>NAT
<ul class="org-ul">
<li>NAT gateways</li>
<li>NAT instances</li>
</ul></li>
<li>DHCP options sets</li>
<li>DNS</li>
<li>VPC peering</li>
<li>Elastic IP address</li>
<li>ClassicLink</li>
</ul>
</div>
</div>
</section>

<section id="outline-container-org3717110" class="outline-2">
<h2 id="org3717110">CloudFormation Skills</h2>
<div class="outline-text-2" id="text-org3717110">
</div>
<div id="outline-container-org40843f9" class="outline-3">
<h3 id="org40843f9">Use FindInMap to customize environment variables based on keys</h3>
<div class="outline-text-3" id="text-org40843f9">
<ul class="org-ul">
<li>Goal: we want to form a aws resources string from environment map based on different conditions.</li>
<li><p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span class="org-variable-name">AWSTemplateFormatVersion</span>: <span class="org-string">'2010-09-09'</span>
<span class="org-variable-name">Description</span>: Resources supporting the App Service
<span class="org-variable-name">Parameters</span>:
  <span class="org-variable-name">StackPrefix</span>:
    <span class="org-variable-name">Type</span>: String
    ...
    <span class="org-variable-name">Type</span>: String
    <span class="org-variable-name">Default</span>: <span class="org-string">'dummy000000000000000001'</span>
<span class="org-variable-name">Mappings</span>:
  <span class="org-variable-name">TableMap</span>:
    <span class="org-variable-name">ReplicateTables</span>:
      <span class="org-variable-name">TenantMaster</span>: <span class="org-string">'app-tenant-master'</span>
      <span class="org-variable-name">ApiKeyTable</span>: <span class="org-string">'app-dummy-service-apikey'</span>
      <span class="org-variable-name">UserTenantTable</span>: <span class="org-string">'app-dummy-service-user-tenant'</span>
  <span class="org-variable-name">EnvironmentMap</span>:
    <span class="org-variable-name">dev</span>:
      <span class="org-variable-name">AppRootUrl</span>: <span class="org-string">"lb.dev.nxapp.com/app"</span>
      <span class="org-variable-name">DesiredCount</span>: <span class="org-string">'2'</span>
      <span class="org-variable-name">MinCapacity</span>: 2
      ...
      <span class="org-variable-name">UseWMService</span>: 1
      <span class="org-variable-name">ApiKeyValidate</span>: 1
      <span class="org-variable-name">DRSrcEnv</span>: dev
    <span class="org-variable-name">drdev</span>:
      <span class="org-variable-name">AppRootUrl</span>: <span class="org-string">"lb.drdev.nxapp.com/app"</span>
      <span class="org-variable-name">DesiredCount</span>: <span class="org-string">'1'</span>
      <span class="org-variable-name">MinCapacity</span>: 1
      ...
      <span class="org-variable-name">UseWMService</span>: 1
      <span class="org-variable-name">ApiKeyValidate</span>: 1
      <span class="org-variable-name">DRSrcEnv</span>: dev

<span class="org-comment">...</span>

<span class="org-variable-name">Resource</span>:
  - <span class="org-type">!Sub</span> <span class="org-string">'arn:aws:dynamodb:*:*:table/app-*-${StackEnvironment}/index/*'</span>
  - <span class="org-variable-name">Fn::Sub</span>:
    - <span class="org-string">'arn:aws:dynamodb:*:*:table/${table}-${srcenv}'</span>
    - <span class="org-variable-name">table</span>:
<span class="org-yaml-tab">        </span><span class="org-variable-name">Fn::FindInMap</span>:
<span class="org-yaml-tab">        </span>  - TableMap
<span class="org-yaml-tab">        </span>  - <span class="org-type">!Ref</span> <span class="org-string">'ReplicateTables'</span>
<span class="org-yaml-tab">        </span>  - TenantMaster
      <span class="org-variable-name">srcenv</span>:
<span class="org-yaml-tab">        </span><span class="org-variable-name">Fn::FindInMap</span>:
<span class="org-yaml-tab">        </span>  - EnvironmentMap
<span class="org-yaml-tab">        </span>  - <span class="org-type">!Ref</span> <span class="org-string">'ConfigEnvironment'</span>
<span class="org-yaml-tab">        </span>  - DRSrcEnv
  - <span class="org-variable-name">Fn::Sub</span>:
    - <span class="org-string">'arn:aws:dynamodb:*:*:table/${table}-${srcenv}/index/*'</span>
    - <span class="org-variable-name">table</span>:
<span class="org-yaml-tab">        </span><span class="org-variable-name">Fn::FindInMap</span>:
<span class="org-yaml-tab">        </span>  - TableMap
<span class="org-yaml-tab">        </span>  - <span class="org-type">!Ref</span> <span class="org-string">'ReplicateTables'</span>
<span class="org-yaml-tab">        </span>  - TenantMaster
      <span class="org-variable-name">srcenv</span>:
<span class="org-yaml-tab">        </span><span class="org-variable-name">Fn::FindInMap</span>:
<span class="org-yaml-tab">        </span>  - EnvironmentMap
<span class="org-yaml-tab">        </span>  - <span class="org-type">!Ref</span> <span class="org-string">'ConfigEnvironment'</span>
<span class="org-yaml-tab">        </span>  - DRSrcEnv      

<span class="org-comment">...</span>
<span class="org-variable-name">APP_ROOT_URL</span>: <span class="org-type">!FindInMap</span>
  - EnvironmentMap
  - <span class="org-type">!Ref</span> ConfigEnvironment
  - AppRootUrl
</pre>
</div>
<ul class="org-ul">
<li>See <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html">Fn::Sub</a> for syntax rule. In general, the values is subtituded from two variable <code>table</code> and <code>srcenv</code> and each of them is referenced by the environment map defined <code>Mappings</code>.</li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="outline-container-org1ccd092" class="outline-2">
<h2 id="org1ccd092">My notes</h2>
<div class="outline-text-2" id="text-org1ccd092">
</div>
<div id="outline-container-org41d381e" class="outline-3">
<h3 id="org41d381e">Network Fundamentals</h3>
</div>
</section>
</main>
<footer id="postamble" class="status">
<div class='footer'>
  Copyright © 2020 <a href='mailto:hyperion_z@outlook.com'>Zhao Wei.</a><br>
  Inspired by <a href='https://nicolas.petton.fr'>https://nicolas.petton.fr</a> <br>
  Last updated on Apr 23, 2021. Generated using <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.0.91 (<a href="https://orgmode.org">Org</a> mode 9.4.5).
</div>
</footer>
</body>
</html>
